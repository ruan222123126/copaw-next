name: nightly-live

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  live:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Cache Go modules/build
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - uses: pnpm/action-setup@v4
        with:
          version: 10.23.0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies (retry)
        run: |
          set -euo pipefail
          for attempt in 1 2 3; do
            if pnpm install --recursive --frozen-lockfile; then
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then
              sleep $((attempt * 10))
            fi
          done
          echo "pnpm install failed after retries" >&2
          exit 1

      - name: Validate live provider secrets
        env:
          NEXTAI_LIVE_OPENAI_API_KEY: ${{ secrets.NEXTAI_LIVE_OPENAI_API_KEY || secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "${NEXTAI_LIVE_OPENAI_API_KEY}" ]; then
            echo "NEXTAI_LIVE_OPENAI_API_KEY (or OPENAI_API_KEY) is required for nightly live checks" >&2
            exit 1
          fi

      - name: Run nightly live checks with retry
        env:
          NEXTAI_LIVE_OPENAI_API_KEY: ${{ secrets.NEXTAI_LIVE_OPENAI_API_KEY || secrets.OPENAI_API_KEY }}
          NEXTAI_LIVE_OPENAI_BASE_URL: ${{ secrets.NEXTAI_LIVE_OPENAI_BASE_URL || secrets.OPENAI_BASE_URL }}
          NEXTAI_LIVE_OPENAI_MODEL: ${{ vars.NEXTAI_LIVE_OPENAI_MODEL || 'gpt-4o-mini' }}
        run: |
          set -euo pipefail
          for attempt in 1 2 3; do
            echo "nightly live attempt ${attempt}/3"
            if pnpm --dir tests/smoke test -- --test-name-pattern "nightly live provider chain"; then
              echo "nightly live checks passed"
              exit 0
            fi
            if [ "$attempt" -lt 3 ]; then
              sleep $((attempt * 20))
            fi
          done
          echo "nightly live checks failed after 3 attempts" >&2
          exit 1

      - name: Create failure alert issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const title = '[nightly-live] job failed';
            const body = [
              `Nightly live workflow failed.`,
              '',
              `- workflow: ${context.workflow}`,
              `- run id: ${context.runId}`,
              `- run url: ${runUrl}`,
              `- commit: ${context.sha}`,
            ].join('\n');

            const existing = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 100,
              labels: 'nightly-live',
            });

            const issue = existing.data.find((i) => i.title === title);
            if (issue) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body,
              });
              return;
            }

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['nightly-live', 'ci'],
            });
